{% extends "login/index.html" %}

{% block title %}Add New Vehicle{% endblock %}

{% block content %}
<div class="form-container">
    <h1>Add a New Vehicle</h1>
    <form method="post" id="vehicle-form" action="{% url 'selectVehicle:create_vehicle' %}">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
            <ul class="errorlist">
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% endif %}

        <div class="form-field">
            <label for="{{ form.vin.id_for_label }}">{{ form.vin.label }}</label>
            {{ form.vin }}
            {% if form.vin.errors %}
                <ul class="errorlist">
                    {% for error in form.vin.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>

        <div class="form-field">
            <label for="{{ form.make.id_for_label }}">{{ form.make.label }}</label>
            {{ form.make }}
            {% if form.make.errors %}
                <ul class="errorlist">
                    {% for error in form.make.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>

        <div class="form-field">
            <label for="{{ form.model.id_for_label }}">{{ form.model.label }}</label>
            {{ form.model }}
            {% if form.model.errors %}
                <ul class="errorlist">
                    {% for error in form.model.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>

        <div class="form-field">
            <label for="{{ form.year.id_for_label }}">{{ form.year.label }}</label>
            {{ form.year }}
            {% if form.year.errors %}
                <ul class="errorlist">
                    {% for error in form.year.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>

        <button type="submit" class="button">Save Vehicle</button>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Function to load models when a make is selected
        $('#id_make').change(function() {
            const makeId = $(this).val();
            const modelSelect = $('#id_model');

            // Clear the current models dropdown
            modelSelect.empty();
            modelSelect.append($('<option></option>').attr('value', '').text('---------'));

            if (makeId) {
                $.ajax({
                    url: "{% url 'selectVehicle:get_models' %}",
                    data: { 'make_id': makeId },
                    dataType: 'json',
                    success: function(models) {
                        models.forEach(function(model) {
                            modelSelect.append($('<option></option>').attr('value', model.id).text(model.name));
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching models:', error);
                    }
                });
            }
        });

        // Trigger the change event on page load if a make is already selected
        // This is important for form re-population on validation errors
        if ($('#id_make').val()) {
            $('#id_make').trigger('change');
        }
    });
</script>

{% endblock %}